<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BYBIT Dashboard</title>
  <link rel="stylesheet" href="dashboard.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ===== Desktop & Shared (desktop layout preserved) ===== */
    body { background:#0a0c1b; color:#e5e7eb; margin:0; }
    .profile { padding:20px 0; background:#0a0c1b; color:#fff; }
    .profile-card{
      display:flex; align-items:center; gap:16px; max-width:900px; margin:auto;
      background:transparent!important; padding:20px; border-radius:12px;
      border:1px solid rgba(255,255,255,.08); box-shadow:0 4px 15px rgba(0,0,0,.4);
    }
    .profile-pic-container{ display:flex; align-items:center; justify-content:center; }
    .profile-pic{
      width:90px; height:90px; border-radius:50%; object-fit:cover;
      border:2.5px solid #fff;
      box-shadow:0 0 8px rgba(255,255,255,.4);
      transition:box-shadow .3s;
      flex:0 0 90px; cursor:pointer;
    }
    .profile-pic:hover{ box-shadow:0 0 14px rgba(255,255,255,.8); }
    .profile-info{ flex:1; min-width:0; }
    .name-row{ display:flex; align-items:center; gap:8px; flex-wrap:nowrap; }
    .profile-info h2{
      margin:0; font-size:1.2rem; font-weight:800!important; color:#fff; line-height:1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    /* ‚úÖ Thick Bybit-green verification check */
    .gold-check{
      width:20px; height:20px; border-radius:999px; flex:0 0 20px;
      display:inline-flex; align-items:center; justify-content:center;
      background:#16c784; border:none; vertical-align:middle; transform:translateY(1px);
    }
    .gold-check svg{ width:14px; height:14px; display:block; }
    .gold-check path{
      stroke:#fff; stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round; fill:none;
    }
    /* ‚úÖ Verified pill */
    .badge-dark{
      margin-top:6px; background:#16c784; color:#fff; border:none;
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; font-size:.72rem; line-height:1;
    }
    .badge-dark path{
      stroke:#fff; stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round; fill:none;
    }

    .profile-info p{ margin:8px 0 0; font-size:1rem; color:#fff; }
    .plan-value, .amount-value{ font-weight:800!important; color:#ffcc00; }

    /* Base crypto banner (centered) */
    .crypto-banner{
      background:transparent!important;
      display:flex; gap:16px;
      justify-content:center; align-items:center;
      flex-wrap:wrap; margin-top:8px;
      padding:12px 0;
    }
    .crypto-banner img{ height:40px; width:auto; }

    .about, .contact{
      background:rgba(255,255,255,0.04)!important; color:#e5e7eb;
      border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.25);
    }
    .testimonials{ background:#0f1326!important; color:#cfd6e4; }
    .secondary{ background:rgba(255,255,255,0.1)!important; color:#fff; }

    /* ===== MOBILE-ONLY LAYOUT (‚â§600px) ‚Äî desktop stays intact ===== */
    @media (max-width: 600px){
      .container{ width:100%; padding-inline:16px; }
      .profile{ padding:16px 0; }
      .profile-card{
        display:grid; grid-template-columns: auto 1fr;
        align-items:center; gap:12px; padding:16px;
        background: rgba(255,255,255,.03) !important;
        border: 1px solid rgba(255,255,255,.08); border-radius:12px;
        box-shadow: 0 6px 20px rgba(0,0,0,.30);
      }
      .profile-pic{ width:78px; height:78px; flex:0 0 78px; }
      .name-row{ gap:6px; }
      .profile-info h2{
        font-size:1.1rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      }
      .badge-dark{ margin-top:6px; padding:6px 10px; font-size:.72rem; line-height:1; }
      .profile-info p{ margin-top:10px; font-size:.95rem; opacity:.95; }
      .crypto-banner{ gap:12px; }
      .crypto-banner img{ height:34px; }
      .forex-ticker{ overflow:hidden; }
      .forex-track{ display:flex; gap:16px; white-space:nowrap; padding-block:8px; }

      .about, .contact, .testimonials .testimonial{
        background: rgba(255,255,255,.03) !important;
        border: 1px solid rgba(255,255,255,.08);
        border-radius:12px; padding:16px;
      }

      .header .nav a, .logout-btn{ min-height:44px; padding:0 10px; border-radius:999px; }
      .footer{ padding-bottom: calc(16px + env(safe-area-inset-bottom)); }
    }

    /* ===== Avatar picker modal ===== */
    #avatarModal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.6);
      display: none; align-items: center; justify-content: center;
      z-index: 9999;
    }
    #avatarModal.open { display: flex; }
    #avatarModal .sheet {
      width: min(720px, 92vw);
      background: #0b0f1f;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      color:#e5e7eb;
    }
    .sheet-head {
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .sheet-head h3 { margin:0; font-size:1rem; font-weight:800; }
    .sheet-head .close {
      background:transparent; color:#fff; border:none; font-size:22px; cursor:pointer; line-height:1;
    }
    .sheet-body { padding: 16px; }
    .avatar-grid {
      display: grid; gap: 12px;
      grid-template-columns: repeat(5, 64px);
      justify-content: center;
    }
    @media (max-width: 520px){
      .avatar-grid { grid-template-columns: repeat(4, 64px); }
    }
    .avatar-tile {
      width: 64px; height: 64px; border-radius: 50%;
      overflow: hidden; display: grid; place-items: center;
      border: 2px solid transparent; padding: 2px; cursor: pointer;
      background: radial-gradient(120px 120px at 50% -30% , rgba(255,255,255,.08), rgba(255,255,255,0));
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .avatar-tile:hover { transform: translateY(-1px); }
    .avatar-tile.selected {
      border-color: #16c784;
      box-shadow: 0 0 0 3px rgba(22,199,132,.25);
    }
    .sheet-foot {
      padding: 12px 16px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; justify-content:flex-end;
    }
    .sheet-foot button{
      border:none; padding:10px 14px; border-radius:10px; cursor:pointer;
    }
    .btn-muted{ background:#1a2035; color:#e5e7eb; }
    .btn-primary{ background:#16c784; color:#0b0f1f; font-weight:700; }
    .btn-primary:disabled{ opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="header">
  <div class="container header-container">
    <a href="#hero" class="logo" style="color:white;text-decoration:none;font-weight:bold;">BYBIT</a>
    <nav class="nav">
      <a href="#hero">Home</a>
      <a href="#about">About Us</a>
      <a href="#contact">Contact</a>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </nav>
  </div>
</header>

<!-- ===== PROFILE ===== -->
<section class="profile" id="profile">
  <div class="container profile-card">
    <div class="profile-pic-container">
      <img src="images/profile.png" alt="Profile Picture" class="profile-pic" id="profilePic" />
    </div>
    <div class="profile-info">
      <div class="name-row">
        <h2 id="fullName">QUEEN PARKER</h2>
        <span class="gold-check" aria-label="Verified">
          <svg viewBox="0 0 20 20" aria-hidden="true">
            <path d="M5.5 10.2 8.3 13l6.2-6.2"></path>
          </svg>
        </span>
      </div>
      <div class="badge-dark" title="Verified">
        <svg viewBox="0 0 20 20" aria-hidden="true">
          <path d="M5 10l3 3 7-7"></path>
        </svg>
        Verified
      </div>
      <p id="investmentPlan">Investment Plan: <span class="plan-value">WEB3</span></p>
      <p id="amountInvested">Amount Invested: $<span class="amount-value">0</span></p>
    </div>
  </div>
</section>

<!-- ===== HERO ===== -->
<section class="hero" id="hero">
  <div class="container hero-content">
    <h1>Welcome to Your Dashboard</h1>
    <p>Track your investments, manage your plans, and grow your portfolio.</p>
  </div>
</section>

<!-- ===== CRYPTO BANNER ===== -->
<div class="crypto-banner container" id="crypto">
  <img src="images/bitcoin.png" alt="BTC" />
  <img src="images/ethereum.png" alt="ETH" />
  <img src="images/tether.png" alt="USDT" />
  <img src="images/solana.png" alt="SOL" />
</div>

<!-- ===== FOREX TICKER ===== -->
<div class="forex-ticker" id="forex">
  <div class="forex-track">
    <span>EUR/USD üîº Buy @ 1.0880</span>
    <span>GBP/USD üîΩ Sell @ 1.2750</span>
    <span>USD/JPY üîº Buy @ 143.20</span>
    <span>AUD/USD üîΩ Sell @ 0.6680</span>
  </div>
</div>

<!-- ===== ABOUT / CONTACT / TESTIMONIALS ===== -->
<section class="about container" id="about" style="display: none;">
  <h2>About Us</h2>
  <p>At Bybit, our mission is to empower every investor with the best</p>
</section>

<section class="contact container" id="contact" style="display: none;">
  <h2>Contact Us</h2>
  <p>Need help or have questions? Reach out to us anytime.</p>
</section>

<section class="testimonials container" id="testimonials">
  <h2>What Our Investors Say</h2>
  <div class="testimonial">
    <p>‚ÄúBybit helped me grow my crypto portfolio safely!‚Äù</p>
    <strong>‚Äî Ann Coopman</strong>
  </div>
</section>

<!-- ===== FOOTER ===== -->
<footer class="footer">
  <div class="container footer-container">
    <div class="footer-col">
      <h4>Quick Links</h4>
      <ul>
        <li><a href="#hero">Home</a></li>
        <li><a href="#plans">Investment Plans</a></li>
        <li><a href="#about">About Us</a></li>
        <li><a href="#contact">Contact</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <ul>
        <li><a href="#">How It Works</a></li>
        <li><a href="#">Security & Rent</a></li>
      </ul>
    </div>
  </div>
  <div class="footer-bottom">
    <p>¬© 2025 Bybit Global Ltd. All rights reserved.</p>
    <a href="#">Terms & Conditions</a>
  </div>
</footer>

<!-- ===== AVATAR PICKER MODAL ===== -->
<div id="avatarModal" role="dialog" aria-modal="true" aria-labelledby="avatarTitle">
  <div class="sheet">
    <div class="sheet-head">
      <h3 id="avatarTitle">Choose your avatar</h3>
      <button class="close" id="avatarCloseBtn" aria-label="Close">√ó</button>
    </div>
    <div class="sheet-body">
      <div id="avatarGrid" class="avatar-grid"></div>
    </div>
    <div class="sheet-foot">
      <button class="btn-muted" id="avatarCancelBtn">Cancel</button>
      <button class="btn-primary" id="avatarSaveBtn" disabled>Save</button>
    </div>
  </div>
</div>

<!-- ===== SCRIPTS ===== -->
<script>
document.addEventListener('DOMContentLoaded', async () => {
  /* ---------- API + auth ---------- */
  let API_URL = (window.APP_CONFIG && window.APP_CONFIG.API_URL) || 'https://bybit-backend-xeuv.onrender.com';
  try { const u = new URL(API_URL); API_URL = u.protocol + '//' + u.host; } catch {}
  const buildApi = (p) => API_URL + (String(p).startsWith('/') ? '' : '/') + p;
  const getToken = () => { try { return (localStorage.getItem('token')||'').trim(); } catch { return ''; } };
  const clearToken = () => { try { localStorage.removeItem('token'); } catch {} };
  async function apiGet(path) {
    const res = await fetch(buildApi(path), {
      method: 'GET', mode: 'cors', cache: 'no-store',
      headers: { Authorization: 'Bearer ' + getToken(), Accept: 'application/json' }
    });
    return res;
  }

  const token = getToken();
  if (!token) {
    alert('Session expired. Please login again.');
    clearToken();
    window.location.href = 'index.html';
    return;
  }

  /* ---------- Load user ---------- */
  let user = {};
  try {
    const res = await apiGet('/api/dashboard');
    if (res.status === 401 || res.status === 403) {
      alert('Session expired. Please login again.');
      clearToken();
      window.location.href = 'index.html';
      return;
    }
    if (!res.ok) throw new Error('Failed to fetch user data');
    user = await res.json();

    /* ---------- NORMALIZE FIELDS FROM MONGODB ---------- */
    const trimTail = (s) => String(s ?? '').replace(/[,\s]+$/,'').trim();
    const toNumber = (v) => {
      const n = Number(String(v ?? 0).replace(/[^\d.-]/g,''));
      return Number.isFinite(n) ? n : 0;
    };

    // Support both "amountInvested" and "amountinvested" + fallbacks
    const amountRaw = user.amountInvested ?? user.amountinvested ?? user.balance ?? user.amount ?? 0;
    const amount = toNumber(amountRaw);

    const fullName = trimTail(user.fullname || user.name || 'QUEEN PARKER');
    const plan = trimTail(user.investmentPlan || user.package || user.plan || 'WEB3');

    // Populate UI
    const fullNameEl = document.getElementById('fullName');
    if (fullNameEl) fullNameEl.textContent = fullName;

    const planValEl = document.querySelector('.plan-value');
    if (planValEl) planValEl.textContent = plan;

    const amountValEl = document.querySelector('.amount-value');
    if (amountValEl) amountValEl.textContent = amount.toLocaleString();

    const picEl = document.getElementById('profilePic');
    // Prefer server pic; fallback to saved local
    const savedLocalPic = (()=>{ try { return localStorage.getItem('profilePic') || ''; } catch { return ''; }})();
    if (picEl) {
      if (user.profilePic) picEl.src = user.profilePic + (user.profilePic.startsWith('data:') ? '' : ('?t=' + Date.now()));
      else if (savedLocalPic) picEl.src = savedLocalPic;
    }

  } catch (err) {
    console.error(err);
    alert('Session expired or server error. Please login again.');
    clearToken();
    window.location.href = 'index.html';
    return;
  }

  /* ---------- Navigation: Home / About / Contact / Logout ---------- */
  function showOnly(sectionId) {
    const ids = ['profile','hero','crypto','forex','about','contact','testimonials'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      const keepForHero = (sectionId === 'hero' && ['profile','hero','crypto','forex','testimonials'].includes(id));
      el.style.display = (id === sectionId || keepForHero) ? 'block' : 'none';
    });
    if (sectionId) {
      const hash = '#' + sectionId;
      if (location.hash !== hash) history.replaceState(null, '', hash);
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  [['#hero','hero'], ['#about','about'], ['#contact','contact']].forEach(([href, id]) => {
    document.querySelectorAll(`a[href="${href}"]`).forEach(a => {
      a.addEventListener('click', (e) => { e.preventDefault(); showOnly(id); });
    });
  });

  document.querySelectorAll('.logo').forEach(el => {
    el.addEventListener('click', (e) => { e.preventDefault(); showOnly('hero'); });
  });

  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      clearToken();
      showOnly('hero');
      window.location.href = 'index.html#hero';
    });
  }

  const initial = (location.hash || '#hero').slice(1);
  showOnly(['hero','about','contact'].includes(initial) ? initial : 'hero');

  /* ================== Avatar Picker ================== */
  const modal = document.getElementById('avatarModal');
  const grid = document.getElementById('avatarGrid');
  const saveBtn = document.getElementById('avatarSaveBtn');
  const closeBtn = document.getElementById('avatarCloseBtn');
  const cancelBtn = document.getElementById('avatarCancelBtn');
  const picEl = document.getElementById('profilePic');
  let selectedSrc = null;

  function makeBybitFavicon(bg1, bg2, ring, glyph) {
    const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 128 128">
      <defs>
        <radialGradient id="g" cx="50%" cy="0%" r="100%">
          <stop offset="0%" stop-color="${bg2}" />
          <stop offset="100%" stop-color="${bg1}" />
        </radialGradient>
      </defs>
      <circle cx="64" cy="64" r="60" fill="url(#g)"/>
      <circle cx="64" cy="64" r="58" fill="none" stroke="${ring}" stroke-width="3"/>
      <g transform="translate(40,36)">
        <path d="M10 0h12c10 0 18 8 18 18s-8 18-18 18H10V0zm12 8v20h0c5 0 10-4 10-10s-5-10-10-10z" fill="${glyph}"/>
        <rect x="0" y="0" width="6" height="36" rx="3" fill="${glyph}"/>
      </g>
    </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

  function buildAvatars() {
    const palettes = [
      ['#0b0f1f','#101429','#f0b90b','#f0b90b'],
      ['#0b0f1f','#141a34','#f9d34c','#f9d34c'],
      ['#0b0f1f','#121a2b','#ffd166','#ffd166'],
      ['#0b0f1f','#101829','#ffcc00','#ffcc00'],
      ['#0b0f1f','#0f152a','#ffe082','#ffe082'],
      ['#0b0f1f','#081225','#eab308','#eab308'],
      ['#0b0f1f','#111827','#facc15','#facc15'],
      ['#0b0f1f','#0e1428','#ffd54f','#ffd54f'],
      ['#0b0f1f','#0e152b','#ffde59','#ffde59'],
      ['#0b0f1f','#0d1426','#ffc107','#ffc107'],
      ['#0b0f1f','#131a2e','#ffd166','#f0b90b'],
      ['#0b0f1f','#121a2d','#f9d34c','#ffd166'],
      ['#0b0f1f','#0f172a','#ffd166','#f9d34c'],
      ['#0b0f1f','#0e1528','#f0b90b','#ffd166'],
      ['#0b0f1f','#111a2e','#ffe082','#f0b90b'],
      ['#0b0f1f','#101a2b','#ffc107','#ffe082'],
      ['#0b0f1f','#0f1628','#facc15','#ffc107'],
      ['#0b0f1f','#0d1526','#ffd54f','#facc15'],
      ['#0b0f1f','#0d1528','#ffde59','#ffd54f'],
      ['#0b0f1f','#0f182c','#f0b90b','#ffde59']
    ];
    return palettes.map(p => makeBybitFavicon(...p));
  }

  const AVATARS = buildAvatars();
  grid.innerHTML = '';
  AVATARS.forEach((src, i) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'avatar-tile';
    btn.innerHTML = `<img src="${src}" alt="Avatar ${i+1}" width="64" height="64" style="border-radius:50%;">`;
    btn.addEventListener('click', () => {
      [...grid.querySelectorAll('.avatar-tile')].forEach(n => n.classList.remove('selected'));
      btn.classList.add('selected');
      selectedSrc = src;
      saveBtn.disabled = false;
    });
    grid.appendChild(btn);
  });

  function openAvatarModal() {
    saveBtn.disabled = !selectedSrc;
    modal.classList.add('open');
  }
  function closeAvatarModal() {
    modal.classList.remove('open');
  }

  if (picEl) {
    picEl.addEventListener('click', openAvatarModal);
    const container = picEl.closest('.profile-pic-container');
    if (container) container.addEventListener('click', (e)=> {
      if (e.target === container) openAvatarModal();
    });
  }
  document.getElementById('avatarCloseBtn').addEventListener('click', closeAvatarModal);
  document.getElementById('avatarCancelBtn').addEventListener('click', closeAvatarModal);
  modal.addEventListener('click', (e)=> { if (e.target === modal) closeAvatarModal(); });

  async function saveSelectedAvatar() {
    if (!selectedSrc) return;
    // Update image immediately
    if (picEl) picEl.src = selectedSrc;

    // Persist to backend; fallback to localStorage
    try {
      const res = await fetch(buildApi('/api/profile/picture'), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + (getToken ? getToken() : '')
        },
        body: JSON.stringify({ image: selectedSrc, isDataUrl: true })
      });
      if (!res.ok) throw new Error('save failed');
    } catch (err) {
      try { localStorage.setItem('profilePic', selectedSrc); } catch {}
    }
    closeAvatarModal();
  }
  document.getElementById('avatarSaveBtn').addEventListener('click', saveSelectedAvatar);
});
</script>

</body>
</html>
